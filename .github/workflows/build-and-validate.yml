name: Build frontend and validate

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install frontend deps
        run: |
          npm ci --prefix frontend

      - name: Build frontend
        run: |
          npm run build --prefix frontend

      - name: Copy frontend build to static
        run: |
          mkdir -p static
          cp -r frontend/dist/* static/

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Verify DATABASE_URL when Railway env is set
        run: |
          # If RAILWAY_ENVIRONMENT is set (or set to 1), ensure DATABASE_URL exists
          if [ -n "$RAILWAY_ENVIRONMENT" ] && [ "$RAILWAY_ENVIRONMENT" != "" ]; then
            if [ -z "$DATABASE_URL" ] || [ "$DATABASE_URL" = "" ]; then
              echo "ERROR: RAILWAY_ENVIRONMENT is set but DATABASE_URL is empty. Add a Postgres plugin or mount a persistent volume to avoid data loss across deploys." >&2
              exit 1
            else
              echo "DATABASE_URL is set: OK"
            fi
          else
            echo "RAILWAY_ENVIRONMENT not set; skipping DATABASE_URL verification"
          fi

  railway-sim:
    runs-on: ubuntu-latest
    needs: build
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
    env:
      RAILWAY_ENVIRONMENT: '1'
      DATABASE_URL: 'postgresql://postgres:postgres@localhost:5432/postgres'
      TRADINGVIEW_SECRET: 'ci_test_secret'
      BITGET_DRY_RUN: '1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Wait for Postgres to be ready
        run: |
          python - <<'PY'
          import os, time, sqlalchemy
          url = os.environ.get('DATABASE_URL')
          if not url:
            print('DATABASE_URL not set')
            raise SystemExit(1)
          engine = sqlalchemy.create_engine(url)
          for i in range(20):
            try:
              conn = engine.connect(); conn.close(); print('DB ready'); break
            except Exception:
              time.sleep(1)
          else:
            raise SystemExit('DB not ready after waiting')
          PY

      - name: Run lightweight DB migration
        run: |
          python scripts/migrate_db.py

      - name: Start app
        run: |
          python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 --log-level info &
          echo $! > uvicorn.pid

      - name: Wait for App to be ready
        run: |
          timeout=20
          until curl -fsS http://127.0.0.1:8000/meta; do
            timeout=$((timeout-1))
            if [ $timeout -le 0 ]; then echo 'app failed to start' && exit 1; fi
            sleep 1
          done

      - name: Login as admin
        id: login
        run: |
          token=$(curl -s -X POST http://127.0.0.1:8000/auth/login -H 'Content-Type: application/json' -d '{"username":"admin","password":"admin123"}' | jq -r '.access_token')
          if [ -z "$token" ] || [ "$token" = "null" ]; then echo 'failed to obtain admin token' && exit 1; fi
          echo "token=$token" >> $GITHUB_OUTPUT

      - name: Place a demo trade (debug/place-test)
        run: |
          TOKEN="${{ steps.login.outputs.token }}"
          curl -s -o /tmp/place_test_result -w '%{http_code}' -X POST http://127.0.0.1:8000/debug/place-test -H "Authorization: Bearer $TOKEN" -H "Tradingview-Secret: $TRADINGVIEW_SECRET" -H "Content-Type: application/json" -d '{"secret":"ci_test_secret","signal":"BUY","symbol":"BTCUSDT","size_usd":1.0}'
          rc=$?
          if [ $rc -ne 0 ]; then echo 'place-test request failed' && exit 1; fi
          echo 'place-test response:'; cat /tmp/place_test_result

      - name: Capture trades count
        id: trades_count
        run: |
          count=$(curl -s http://127.0.0.1:8000/trades | jq '. | length') || true
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Restart app to simulate redeploy
        run: |
          kill $(cat uvicorn.pid) || true
          sleep 1
          python -m uvicorn app.main:app --host 127.0.0.1 --port 8000 --log-level info &
          echo $! > uvicorn.pid
          timeout=20
          until curl -fsS http://127.0.0.1:8000/meta; do
            timeout=$((timeout-1))
            if [ $timeout -le 0 ]; then echo 'app failed to start after restart' && exit 1; fi
            sleep 1
          done

      - name: Verify trades persisted after restart
        run: |
          PREV=${{ steps.trades_count.outputs.count }}
          NOW=$(curl -s http://127.0.0.1:8000/trades | jq '. | length') || true
          echo "before=$PREV after=$NOW"
          if [ "$NOW" -lt "$PREV" ]; then echo 'trade history not persisted across restart' && exit 1; fi

      - name: Verify DATABASE_URL when Railway env is set
        run: |
          # If RAILWAY_ENVIRONMENT is set (or set to 1), ensure DATABASE_URL exists
          if [ -n "$RAILWAY_ENVIRONMENT" ] && [ "$RAILWAY_ENVIRONMENT" != "" ]; then
            if [ -z "$DATABASE_URL" ] || [ "$DATABASE_URL" = "" ]; then
              echo "ERROR: RAILWAY_ENVIRONMENT is set but DATABASE_URL is empty. Add a Postgres plugin or mount a persistent volume to avoid data loss across deploys." >&2
              exit 1
            else
              echo "DATABASE_URL is set: OK"
            fi
          else
            echo "RAILWAY_ENVIRONMENT not set; skipping DATABASE_URL verification"
          fi
